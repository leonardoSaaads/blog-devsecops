---
title: "Como Subir um Servi√ßo para Web (Do Jeito Certo)"
date: "2025-10-09"
tags: ["DEVOPS", "DOCKER", "CLOUDFLARE"]
description: "Da maneira f√°cil, segura e sem dor de cabe√ßa"
---

<div align="center">
  <img src="https://i.imgflip.com/a8iy74.jpg" alt="Meme sobre deploy" />
</div>

___

## Por Que Voc√™ Deveria Se Importar Com Isso?

Sabe aquela aplica√ß√£o que voc√™ desenvolveu na sua m√°quina e quer mostrar pro mundo? Ou aquele sistema de monitoramento que precisa ficar acess√≠vel de qualquer lugar? O problema √© que a maioria dos tutoriais **N√ÉO** te ensina a fazer isso de forma **segura**.

Neste post, vou te mostrar como fazer deploy de forma:
- **Segura**: Sem expor portas do seu servidor diretamente na internet
- **Simples**: Usando ferramentas gratuitas e poucas linhas de c√≥digo
- **Profissional**: Do jeito que empresas grandes fazem

**O que vamos usar?**
- **Docker**: Para empacotar nossa aplica√ß√£o (pense como se fosse um "zip" que cont√©m tudo que sua aplica√ß√£o precisa)
- **Cloudflare Tunnel**: Para criar um caminho seguro da internet at√© sua aplica√ß√£o (sem abrir portas no firewall!)
- **Prometheus**: Nosso exemplo pr√°tico (um sistema de monitoramento usado por Netflix, Uber, etc)

___

## Parte 1: Entendendo o Cloudflare Tunnel

### O Problema Tradicional

Normalmente, para colocar um servi√ßo na web, voc√™ faria:
1. Abrir portas no seu firewall (perigoso! ‚ö†Ô∏è)
2. Configurar um IP p√∫blico (caro e complexo)
3. Lidar com ataques diretos no seu servidor (estressante)

### A Solu√ß√£o: Cloudflare Tunnel

O Cloudflare Tunnel inverte a l√≥gica:

**M√©todo Tradicional:**
```markdown
Internet ‚Üí [Porta Aberta no Firewall] ‚Üí Seu Servidor
           ‚ò†Ô∏è Vulner√°vel a ataques (It's over)
```

**Com Cloudflare Tunnel:**
```markdown
Seu Servidor ‚Üí [Conex√£o Segura de Sa√≠da] ‚Üí Cloudflare ‚Üí Internet
               üõ°Ô∏è Seu servidor nunca √© exposto
```

**A m√°gica:** Seu servidor estabelece uma conex√£o **de dentro para fora** (outbound) com a Cloudflare. Quando algu√©m acessa seu site, o tr√°fego passa pela rede global da Cloudflare e chega at√© voc√™ atrav√©s desse t√∫nel seguro.

**Analogia simples:** √â como se voc√™ ligasse para uma central telef√¥nica e deixasse a linha aberta. Quando algu√©m quer falar com voc√™, a central transfere a liga√ß√£o - mas ningu√©m tem seu n√∫mero direto.

### Vocabul√°rio Essencial (N√£o Pule Isso!)

Antes de continuar, vamos entender os termos que vou usar:

**üîπ T√∫nel (Tunnel)**
- O "caminho seguro" entre seu servidor e a Cloudflare
- Cada t√∫nel tem um ID √∫nico (UUID) tipo: `a3f2e8b1-...`
- Voc√™ pode ter v√°rios t√∫neis diferentes, cada um com um prop√≥sito

**üîπ Cloudflared**
- O programa que roda no seu servidor
- Ele cria e mant√©m o t√∫nel ativo
- Pense nele como um "porteiro" que cuida da comunica√ß√£o

**üîπ Conector**
- √â o cloudflared instalado e rodando
- Cria 4 conex√µes simult√¢neas para ter redund√¢ncia
- Se uma conex√£o cair, as outras mant√™m tudo funcionando

**üîπ T√∫nel Gerenciado Remotamente**
- Configurado pelo site da Cloudflare (mais f√°cil!)
- As configura√ß√µes ficam na nuvem
- √â o que vamos usar neste tutorial

**üîπ Docker e Containers**
- **Container**: Como uma "caixa isolada" que roda sua aplica√ß√£o
- **Docker Compose**: Arquivo que descreve como os containers devem funcionar
- **Bridge Network**: Uma "ponte virtual" que permite containers conversarem entre si
- **Volume**: Espa√ßo para salvar dados que n√£o devem sumir quando o container reinicia

___

## Parte 2: A Arquitetura Que Vamos Construir

Antes de colocar a m√£o na massa, vamos entender **o que** vamos construir e **por que** cada pe√ßa existe.

<div align="center">
  <img src="/images/cloudflare/cloudflare-tunnel/tutorial_diagram.png" alt="Diagrama da arquitetura" />
</div>

### O Fluxo Completo (Passo a Passo)

```markdown
Voc√™ no Celular/PC
    ‚Üì
[1] Acessa prom.seudominio.com
    ‚Üì
[2] Cloudflare Edge Network (Rede Global)
    ‚Üì
[3] T√∫nel Seguro (Conex√£o Criptografada)
    ‚Üì
[4] Container cloudflared (no seu servidor)
    ‚Üì
[5] Rede Bridge Interna (comunica√ß√£o entre containers)
    ‚Üì
[6] Container Prometheus (sua aplica√ß√£o)
```

### Os Componentes

**1Ô∏è‚É£ Container Cloudflared (O Porteiro)**
- Fun√ß√£o: Gerenciar o t√∫nel com a Cloudflare
- Conecta-se √† internet usando apenas conex√µes de sa√≠da (nenhuma porta aberta!)
- Redireciona tr√°fego web para o Prometheus

**2Ô∏è‚É£ Container Prometheus (A Aplica√ß√£o)**
- Fun√ß√£o: Sistema de monitoramento (nosso exemplo)
- Roda na porta 9090 **APENAS internamente** (n√£o √© acess√≠vel da internet)
- S√≥ o cloudflared consegue falar com ele

**3Ô∏è‚É£ Rede Bridge "monitoring"**
- Fun√ß√£o: Permite os containers conversarem entre si
- √â como uma "rede local virtual" s√≥ para os containers
- Isolada e segura

**4Ô∏è‚É£ Volumes (Armazenamento Persistente)**
- `prometheus_data`: Guarda dados do Prometheus (n√£o perde quando reinicia)
- Configura√ß√µes montadas do seu disco para dentro do container

### Por Que Esta Arquitetura √© Boa?

‚úÖ **Seguran√ßa em Camadas:**
- Firewall n√£o precisa abrir portas
- Containers isolados uns dos outros
- Prometheus inacess√≠vel diretamente

‚úÖ **Facilidade de Gerenciamento:**
- Tudo configurado em 2 arquivos
- F√°cil de replicar em outros servidores
- Backup simples (s√≥ copiar a pasta)

‚úÖ **Escalabilidade:**
- Quer adicionar mais servi√ßos? S√≥ adicionar mais containers
- Cada servi√ßo pode ter seu pr√≥prio subdom√≠nio

___

## HANDS-ON: Parte 1 - Preparando o Ambiente

### Estrutura de Arquivos (O Que Vamos Criar)

```markdown
prometheus-stack/               
‚îú‚îÄ‚îÄ docker-compose.yml          # Orquestra os containers
‚îú‚îÄ‚îÄ prometheus/                 
‚îÇ   ‚îú‚îÄ‚îÄ prometheus.yml          # Arquivo de configura√ß√£o principal
‚îÇ   ‚îî‚îÄ‚îÄ rules/                  # Regras de alertas (vazio por enquanto)
‚îî‚îÄ‚îÄ prometheus_data/            # Ser√° criado automaticamente (dados persistentes)
```

**Por que essa estrutura?**
- `docker-compose.yml`: Descreve TODOS os containers e como eles interagem
- `prometheus/`: Mant√©m configura√ß√µes separadas e organizadas
- `prometheus_data/`: Docker cria automaticamente para salvar dados

### Passo 1: Criar a Estrutura de Pastas

Escolha onde quer trabalhar. Recomendo sua pasta de usu√°rio:

```bash
# Navega para sua home
cd ~

# Cria as pastas de uma vez
mkdir -p prometheus-stack/prometheus/rules

# Entra na pasta do projeto
cd prometheus-stack
```

### Passo 2: Criar o docker-compose.yml

Agora vem a parte gostosa: o arquivo que orquestra tudo. Crie o arquivo abaixo:

**prometheus-stack/docker-compose.yml**

```yaml
# Define volumes (armazenamento persistente)
volumes:
  prometheus_data: {}  # Docker gerencia automaticamente onde salvar

# Define redes (comunica√ß√£o entre containers)
networks:
  monitoring:
    driver: bridge  # Tipo de rede: bridge = rede privada virtual

# Define os servi√ßos (containers)
services:
  
  # ========== SERVI√áO 1: PROMETHEUS ==========
  prometheus:
    image: prom/prometheus:v3.6.0      # Imagem oficial do Prometheus
    container_name: prometheus         # Nome para identificar
    restart: unless-stopped            # Reinicia automaticamente, exceto se parado manualmente
    
    # Volumes: mapeia arquivos do host ‚Üí container
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro  # :ro = read-only
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus    # Volume gerenciado (dados persistentes)
    
    # Comandos passados para o Prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'  # Guarda dados por 15 dias
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'       # Permite reload sem reiniciar
      - '--web.enable-admin-api'       # Habilita API administrativa
    
    # Portas: host:container
    ports:
      - "9090:9090"  # Acess√≠vel em localhost:9090 (APENAS localmente!)
    
    # Redes √†s quais este container pertence
    networks:
      - monitoring
    
    # CONFIGURA√á√ïES DE SEGURAN√áA
    user: "nobody"  # Roda como usu√°rio sem privil√©gios (n√£o √© root)
    security_opt:
      - no-new-privileges:true  # Impede escalar privil√©gios
    read_only: true  # Sistema de arquivos somente leitura (imut√°vel)
    tmpfs:
      - /tmp  # Exce√ß√£o: /tmp precisa ser grav√°vel (tempor√°rio)
  
  # ========== SERVI√áO 2: CLOUDFLARED ==========
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    
    # IMPORTANTE: Substitua <SEU_TOKEN_AQUI> pelo token da Cloudflare
    command: tunnel --no-autoupdate run --token <SEU_TOKEN_AQUI>
    
    networks:
      - monitoring
    
    # Garante que Prometheus sobe ANTES do Cloudflared
    depends_on:
      - prometheus
```

**Explicando as Configura√ß√µes de Seguran√ßa:**

```yaml
user: "nobody"
```
- Container roda como usu√°rio sem privil√©gios
- Se algu√©m invadir o container, n√£o ter√° poder de root
- ‚ö†Ô∏è Nota: Em produ√ß√£o real, crie um usu√°rio espec√≠fico ‚ö†Ô∏è

```yaml
read_only: true
```
- Sistema de arquivos n√£o pode ser modificado
- Impede que atacantes instalem malware
- Exce√ß√£o: `/tmp` via `tmpfs` para arquivos tempor√°rios

```yaml
no-new-privileges:true
```
- Mesmo se houver falha de seguran√ßa, n√£o pode virar root
- Camada extra de prote√ß√£o

### Passo 3: Configurar o Prometheus

Crie a configura√ß√£o do Prometheus:

**prometheus-stack/prometheus/prometheus.yml**

```yaml
# ========== CONFIGURA√á√ïES GLOBAIS ==========
global:
  scrape_interval: 15s      # Coleta m√©tricas a cada 15 segundos
  evaluation_interval: 15s  # Avalia regras a cada 15 segundos
  
  # Labels aplicados a todas as m√©tricas
  external_labels:
    monitor: 'production'
    environment: 'docker'

# ========== REGRAS DE ALERTA ==========
# (Descomentado quando quiser adicionar alertas)
# rule_files:
#   - '/etc/prometheus/rules/*.yml'

# ========== O QUE MONITORAR ==========
scrape_configs:
  # Job 1: Monitorar o pr√≥prio Prometheus
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']  # Monitora a si mesmo
        labels:
          instance: 'prometheus-server'
          environment: 'production'
```

**O que esse arquivo faz:**
- Define **de quanto em quanto tempo** coletar dados (15s)
- Configura **o que monitorar** (neste caso, o pr√≥prio Prometheus)
- Adiciona **etiquetas** aos dados para organiza√ß√£o

### Passo 4: Ajustar Permiss√µes (Importante!)

```bash
chmod 644 prometheus/prometheus.yml
```

### Passo 5: Validar Configura√ß√£o

Antes de subir, vamos verificar se est√° tudo certo:

```bash
# Valida o docker-compose.yml
sudo docker compose config
```

**O que esse comando faz:**
- L√™ o `docker-compose.yml`
- Verifica se h√° erros de sintaxe
- Mostra a configura√ß√£o final (com valores padr√£o expandidos)

**Se houver erro:** Revise os arquivos YAML (cuidado com espa√ßamento!)

### Passo 6: Subir o Prometheus (Primeira Vez)

Vamos subir s√≥ o Prometheus para testar:

```bash
# Inicia APENAS o container do Prometheus
sudo docker compose up prometheus -d
```

**Explicando:**
- `up`: Cria e inicia containers
- `prometheus`: Nome do servi√ßo (s√≥ sobe esse, n√£o o cloudflared ainda)
- `-d`: Detached mode (roda em background)

### Passo 7: Verificar Se Funcionou

```bash
# Ver status dos containers
sudo docker compose ps

# Ver logs em tempo real
sudo docker compose logs -f prometheus
```

**Logs esperados (sucesso):**
```markdown
prometheus  | level=INFO msg="Server is ready to receive web requests."
prometheus  | level=INFO msg="Starting Prometheus Server" version="3.6.0"
```

**Teste final com o `curl` (L√Å ELE INFINITO üòÇ)**
```bash
# Verifica se Prometheus est√° saud√°vel
curl http://localhost:9090/-/healthy
```

**Resposta esperada:**
```
Prometheus Server is Healthy.
```

** Se chegou aqui: Prometheus est√° rodando! O PAI √â BRABU MESMO**

___

## HANDS-ON: Parte 2 - Conectando com a Cloudflare

Agora vem a parte m√°gica: tornar o Prometheus acess√≠vel da internet **sem abrir portas**!

### Passo 0: Acessar a Cloudflare

1. Acesse [dash.cloudflare.com](https://dash.cloudflare.com)
2. Fa√ßa login (ou crie uma conta gratuita)
3. Cadastre (ou j√° possua) um dom√≠nio

### Passo 1: Ir para Zero Trust

No menu lateral, clique em **"Zero Trust"**

<div align="center">
  <img src="/images/cloudflare/cloudflare-tunnel/tutorial_01.png" alt="Zero Trust" />
</div>

**O que √© Zero Trust?**
- Modelo de seguran√ßa moderno onde TUDO precisa provar que √© confi√°vel
- "Nunca confie, sempre verifique"
- Cloudflare Tunnel faz parte desse ecossistema

### Passo 2: Criar um T√∫nel

1. V√° em **Networks ‚Üí Tunnels**
2. Clique em **"Create a tunnel"** (Criar t√∫nel)

<div align="center">
  <img src="/images/cloudflare/cloudflare-tunnel/tutorial_02.png" alt="Criar t√∫nel" />
</div>


### Passo 3: Escolher Cloudflared

**Por que Cloudflared?**
- √â o m√©todo padr√£o e mais simples
- N√£o precisa configurar manualmente certificados
- Funciona em qualquer ambiente (Docker, VM, bare metal)

Selecione **"Cloudflared"** como tipo de conector

<div align="center">
  <img src="/images/cloudflare/cloudflare-tunnel/tutorial_03.png" alt="Tipo Cloudflared" />
</div>

### Passo 4: Nomear o T√∫nel

D√™ um nome, exemplo: `Exemplo_leo_prom`

<div align="center">
  <img src="/images/cloudflare/cloudflare-tunnel/tutorial_04.png" alt="Nome do t√∫nel" />
</div>

### Passo 5: COPIAR O TOKEN (MUITO IMPORTANTE!)

<div align="center">
  <img src="/images/cloudflare/cloudflare-tunnel/tutorial_05.png" alt="T√∫nel conectado" />
</div>

Selecione **"Docker"** na lista de ambientes.

**ATEN√á√ÉO:** Aparecer√° um comando semelhante a:

```bash
docker run cloudflare/cloudflared:latest tunnel --no-autoupdate run --token eyJhIjoiZjU3Y...
                                                                            ^^^^^^^^^^^^^^^^^^^^
                                                                            ESSE √â O TOKEN!
```

**COPIE APENAS O TOKEN** (a parte depois de `--token`)

**‚ö†Ô∏è SEGURAN√áA: GUARDA ESSA PORRA COMO SE FOSSE A SENHA DO BANCO**

- √â s√©rio! Qualquer um com esse token vira dono do seu t√∫nel
- Vazou no Git? J√° era, meu patr√£o. Revoga e gera outro NA HORA
- **NUNCA** compartilhe publicamente

**Em produ√ß√£o, use:**
- Docker Secrets
- Vari√°veis de ambiente
- Vault ou similar

### Passo 6: Adicionar Token no docker-compose.yml

Edite o arquivo `docker-compose.yml` e substitua:

```yaml
# ANTES
command: tunnel --no-autoupdate run --token <SEU_TOKEN_AQUI>

# DEPOIS
command: tunnel --no-autoupdate run --token eyJhIjoiZjU3Y2RlN2ItNmY4Zi00Y...
```

### Passo 7: Subir o Cloudflared

```bash
# Para tudo
sudo docker compose down

# Sobe tudo (Prometheus + Cloudflared)
sudo docker compose up -d
```

**Verificar logs:**
```bash
sudo docker compose logs -f cloudflared
```

**Logs esperados (sucesso):**
```markdown
cloudflared  | Registered tunnel connection
cloudflared  | Connection established
```

**Na interface da Cloudflare:** Deve aparecer "Connected" ‚úÖ

### Passo 8: Configurar o Hostname (Subdom√≠nio)

<div align="center">
  <img src="/images/cloudflare/cloudflare-tunnel/tutorial_06.png" alt="Configurar hostname" />
</div>

**Public Hostname:**
- **Subdomain:** `prom` (ou `monit`, `metrics`, etc)
- **Domain:** Selecione seu dom√≠nio
- **Path:** Deixe vazio se quiser

**Service:**
- **Type:** `HTTP`
- **URL:** `prometheus:9090`

**Por que `prometheus:9090`?**
- `prometheus` √© o nome do container (Docker resolve automaticamente)
- `9090` √© a porta interna do Prometheus
- Cloudflared est√° na mesma rede bridge, ent√£o consegue acessar

**N√£o use:**
- ‚ùå `localhost:9090` (n√£o funciona entre containers)
- ‚ùå `127.0.0.1:9090` (idem)
- ‚úÖ `prometheus:9090` (correto!)

### Passo 9: Salvar e Testar

1. Clique em **"Save tunnel"**
2. Aguarde 10-30 segundos
3. Acesse `https://prom.seudominio.com`

**FUNCIONOU? Voc√™ deve ver a interface do Prometheus acess√≠vel de qualquer lugar! O PAI √â BRABU MESMO**

### Passo 10: Testar Fora da Rede Local

<div align="center">
  <img src="/images/cloudflare/cloudflare-tunnel/tutorial_07.png" alt="Logs do t√∫nel" />
</div>

**Teste definitivo:**

Hora de ver se a parada t√° no ar DE VERDADE ou se √© s√≥ ilus√£o:

1. Pega o celular
2. **Desliga o WiFi** (tem que ser 4G/5G mesmo, sem frescura)
3. Digita `https://prom.seudominio.com`

**Se funcionar:** Parab√©ns! Voc√™ fez um deploy profissional!

___

## Monitoramento e Logs

### Ver Logs dos T√∫neis

Na interface da Cloudflare:

**Networks ‚Üí Tunnels ‚Üí [Seu T√∫nel]**

<div align="center">
  <img src="/images/cloudflare/cloudflare-tunnel/tutorial_09.png" alt="Logs do t√∫nel" />
</div>

**O que procurar:**
- Requests bem-sucedidos (status 200)
- Lat√™ncia (tempo de resposta)
- Erros (status 4xx, 5xx)

### M√©tricas de Tr√°fego

**Networks ‚Üí Tunnels ‚Üí [Seu T√∫nel] ‚Üí Metrics**

**M√©tricas √∫teis:**
- Requests por minuto
- Largura de banda usada
- Status de sa√∫de do conector

### Ver Todos os T√∫neis

<div align="center">
  <img src="/images/cloudflare/cloudflare-tunnel/tutorial_08.png" alt="Lista de t√∫neis" />
</div>

___

## B√¥nus: Adicionando Mais Servi√ßos

Quer expor outros servi√ßos? √â s√≥ adicionar no mesmo t√∫nel!

Voc√™ pode ir em "Rotas de aplicativo publicadas" e depois em "Adicionar uma rota de aplicativo publicada"
___

## Melhorias para Produ√ß√£o (Aquela Ensaboada Bonita Pro Chefe)

Olha, o que fizemos j√° t√° rodando liso. Mas se voc√™ quer MESMO impressionar ou colocar isso num ambiente corporativo, tem uns truques a√≠:

### 1. Autentica√ß√£o

```yaml
# Adicionar Cloudflare Access
# Networks ‚Üí Access ‚Üí Applications ‚Üí Add an application
```

Proteja com:
- Login Google/Microsoft
- One-time PIN por email
- M√∫ltiplos fatores

### 2. Secrets Management

**Nunca coloque tokens no docker-compose.yml!**

```bash
# Usando Docker Secrets
echo "seu_token_aqui" | docker secret create cloudflare_token -

# No docker-compose.yml:
secrets:
  cloudflare_token:
    external: true

services:
  cloudflared:
    secrets:
      - cloudflare_token
    command: tunnel run --token $(cat /run/secrets/cloudflare_token)
```

### 3. HTTPS Interno

```yaml
# Service Type na Cloudflare: HTTPS (n√£o HTTP)
# Requer certificado no Prometheus
```

### 4. Rate Limiting

Na Cloudflare, configure:
- Limite de requisi√ß√µes por IP
- WAF (Web Application Firewall)
- Bot protection

### 5. Backup Automatizado

```bash
# Cron job di√°rio
0 2 * * * docker run --rm -v prometheus_data:/data -v /backup:/backup ubuntu tar czf /backup/prometheus-$(date +\%Y\%m\%d).tar.gz /data
```

### 6. Monitoramento do Monitoramento

```yaml
# Adicione Prometheus Alertmanager
# Configure alertas para:
# - Container parou
# - Disco cheio
# - T√∫nel desconectado
```

___

### Documenta√ß√£o Oficial

- [Cloudflare Tunnels](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/)
- [Prometheus Documentation](https://prometheus.io/docs/introduction/overview/)
- [Docker Compose Reference](https://docs.docker.com/compose/compose-file/)
___


**Gostou?** Compartilhe com quem est√° come√ßando em DevSecOps!
**D√∫vidas?** Me chama no LinkedIn.
**Sugest√µes?** Comenta abaixo üëá
