---
title: "Como monitorar o seu homeserver (ou qualquer coisa)"
date: "2025-10-16"
tags: ["DEVOPS", "DOCKER", "PROMETHEUS", "GRAFANA"]
description: "Da maneira f√°cil, segura e sem dor de cabe√ßa"
---

<div align="center">
  <img src="https://i.imgflip.com/a98k0g.jpg" alt="Meme sobre homeserver" />
</div>

# Um homeserver üòà

Primeiro de tudo... N√£o tem escapat√≥ria. Mesmo que voc√™ tente fugir, n√£o tem como se desprender totalmente das **AMARRAS CLOUD**. 

Em outras palavras, quero transmitir a ideia de que, mesmo voc√™ tentando ter autonomia sobre toda a infraestrutura de seus dados, n√£o tem como ficarmos alheios a uma malha - muitas das vezes invis√≠vel - que s√£o diversos datacenters espalhados pelo mundo. Isso tem um lado bom e tamb√©m um lado ruim. 

O lado ruim √© que seus dados podem ser vazados, podem ser capturados, ficam armazenados nesses gigantes "Bancos Virtuais" e podem ser utilizados para o benef√≠cio mais da empresa do que seu. Por outro lado, muitas das vezes esses datacenters s√£o praticamente fortalezas digitais, preparados para terremotos, furac√µes e seus dados - no pior dos casos - devem ficar inacess√≠veis por uns 4 minutos devido a algum bug maluco.

Nesse sentido, √© interessante voc√™ entender o que ocorre um pouco por baixo dos panos nesses datacenters, como voc√™ pode ter um pouco mais de autonomia e como um homeserver √© interessante nesse cen√°rio.

## O que √© um homeserver?

Como o nome j√° diz, √© literalmente um servidor dom√©stico, √© um computador pessoal que funciona como um hub central para armazenar dados, fazer backup de arquivos, gerenciar a automa√ß√£o residencial e permitir acesso remoto a informa√ß√µes. √â uma forma de centralizar os dados da casa e controlar seus servi√ßos digitais, eliminando a necessidade de servi√ßos na nuvem.

**Voc√™ pode estar se perguntando: L√©o, pra que diabos eu preciso disso?!**

E eu te respondo que essas s√£o as principais raz√µes:

- **Armazenamento e Backup**: Sabe aquelas fotos de 1839 da sua fam√≠lia? Ent√£o, coloque no homeserver (se ele for aqueles com muita mem√≥ria) e voc√™ n√£o precisa ficar pagando R$ 29,90 pro OneDrive toda hora porque o seu limite de 15 gigas estorou.
- **Casa inteligente**: Sim, pode servir como automa√ß√£o para a sua casa e ser a pe√ßa central da SmartHome.
- **Acesso Remoto**: Serve pra voc√™ acessar de qualquer lugar da internet (leia meu post sobre cloudflare tunnel).
- **Hospedagem gratuita**: Ele fica l√° rodando 24 horas pra manter o seu site, seu banco de dados e o que voc√™ desejar.
- **Proxy**: Quando voc√™ est√° naquele pa√≠s duvidoso ou em um local que voc√™ desconfia, esse proxy pode te ajudar.

## Quer ter um home server?

√â literalmente um PC velho com Linux. Sem zoeira, √© literalmente isso. Voc√™ pode usar um PC antigo, um laptop, ou mini PCs como um Raspberry Pi ou coisas assim. 

Existem sistemas operacionais espec√≠ficos para servidores, como zimaOS, que facilitam a instala√ß√£o e o gerenciamento de aplicativos atrav√©s de uma loja integrada. A configura√ß√£o pode variar, mas geralmente envolve conectar o dispositivo √† rede local, instalar o sistema operacional e configurar os servi√ßos desejados atrav√©s do IP do servidor. 

N√£o √© necess√°rio ter um grande conhecimento em computa√ß√£o para come√ßar, especialmente com o uso de sistemas operacionais f√°ceis de usar, como o zimaOS.

---

## Por que raios eu preciso monitorar isso? ü§î

Beleza, voc√™ montou seu homeserver, colocou uns containers rodando, t√° tudo funcionando... **Mas ser√° mesmo?**

Aqui vai a real: um servidor sem monitoramento √© como dirigir um carro sem painel. Voc√™ n√£o sabe se est√° acabando a gasolina, se o motor est√° esquentando, ou se aquele barulho estranho √© normal. Quando voc√™ percebe o problema, **j√° √© tarde demais**.

No mundo dos servidores, isso significa:

- **Seu HD encheu** e voc√™ s√≥ descobriu quando o banco de dados parou de funcionar
- **A CPU estava a 100%** h√° 3 dias e voc√™ nem sabia
- **A mem√≥ria RAM esgotou** e o sistema come√ßou a matar processos aleat√≥rios
- **Algu√©m tentou invadir** seu servidor 47 vezes ontem (sim, acontece)

√â por isso que empresas s√©rias t√™m salas inteiras cheias de dashboards piscando. N√£o √© porque fica bonito (ok, tamb√©m √© por isso üòé), mas porque **preven√ß√£o √© melhor que apagar inc√™ndio**.

E o melhor? Voc√™ vai conseguir montar exatamente isso no seu homeserver, de gra√ßa, e sem precisar de um curso de 6 meses.

---

# Monitorando um homeserver: O trio perfeito üéØ

Existem MUITAS ferramentas de monitoramento por a√≠: Zabbix, Nagios, Datadog, New Relic... Mas vou te mostrar a stack que considero ideal para homeservers: **Prometheus + Grafana + Node Exporter**.

<div align="center">
  <img src="/images/linux/BackgroundMonitoramento.png" alt="Softwares de monitoramento" />
</div>

## Por que essas tr√™s?

### üîç **Node Exporter** - O Espi√£o do Sistema

Pense nele como um agente da CIA instalado no seu sistema operacional. Ele fica l√°, quietinho, coletando informa√ß√µes sobre **tudo**:

- Uso de CPU, mem√≥ria, disco
- Tr√°fego de rede
- Processos rodando
- Temperatura (se seu hardware suportar)
- At√© quantas vezes seu disco foi lido/escrito

Ele n√£o salva nada, n√£o mostra nada. Apenas **exp√µe** essas m√©tricas em um endpoint HTTP (geralmente `:9100/metrics`). √â tipo deixar uma janela aberta com os dados, mas s√≥ quem voc√™ autorizar pode olhar.

### üìä **Prometheus** - O Coletor Obsessivo

Se o Node Exporter √© o espi√£o, o Prometheus √© o arquivista man√≠aco. Ele:

1. Acessa o endpoint do Node Exporter a cada 15 segundos (configur√°vel)
2. **Raspa** (scrape) todas as m√©tricas dispon√≠veis
3. Armazena tudo em um banco de dados de s√©ries temporais otimizado
4. Fica pronto para responder perguntas tipo: "Qual era o uso de CPU √†s 14h37 de ontem?"

Ele funciona no modelo **pull** (ele busca os dados), diferente de ferramentas que funcionam no modelo **push** (os dados s√£o enviados para elas). Isso √© mais seguro e escal√°vel porque o Prometheus controla o que coleta e quando coleta.

### üìà **Grafana** - O Visual

Aqui √© onde a m√°gica acontece. Grafana pega aqueles dados todos do Prometheus e transforma em:

- Dashboards interativos
- Alertas personalizados
- Relat√≥rios automatizados

√â basicamente o PowerPoint dos dados, mas √∫til de verdade. Voc√™ consegue ver em tempo real o que est√° acontecendo no seu servidor de uma forma que at√© sua v√≥ entenderia (talvez).

### üåê **Cloudflare Tunnel** - O Porteiro Seguro

Permite acessar seu Grafana de qualquer lugar do mundo, com HTTPS autom√°tico e **sem abrir portas no roteador**. Seguran√ßa de gra√ßa? RECEBA! Caso queira saber mais, leia o meu post anterior.

---

## O Fluxo Completo

```bash
[SISTEMA LINUX] 
    ‚Üì (coleta m√©tricas do hardware e SO)
[NODE EXPORTER :9100] 
    ‚Üì (scrape a cada 15 segundos)
[PROMETHEUS :9090] 
    ‚Üì (consulta e processa dados)
[GRAFANA :3000] 
    ‚Üì (t√∫nel seguro com HTTPS)
[CLOUDFLARE TUNNEL]
    ‚Üì
[VOC√ä, de qualquer lugar do mundo üåç]
```

Entendeu o esquema? Cada pe√ßa tem um papel espec√≠fico, e juntas formam um sistema completo de observabilidade. √â como uma linha de produ√ß√£o onde cada esta√ß√£o faz exatamente o que precisa fazer.

Agora sim, m√£os √† obra! üõ†Ô∏è

---

## Estruturando o projeto

A primeira parte que precisamos fazer √© estruturar o projeto que estamos criando. Ou seja, criar as pastas, montar o esqueleto, para que posteriormente ganhe o corpo. Vamos criar uma pasta chamada `homeserver-stack`:

```bash
mkdir homeserver-stack
cd homeserver-stack
```

Com a pasta feita, vamos seguir essa estrutura:

```bash
homeserver-stack/
‚îú‚îÄ‚îÄ .gitignore                     # Seguran√ßa (CRIE ISSO PRIMEIRO!)
‚îú‚îÄ‚îÄ docker-compose.yml             # Orquestrador dos containers
‚îú‚îÄ‚îÄ grafana/                       
‚îÇ   ‚îú‚îÄ‚îÄ dashboards/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ node-exporter.json     # Dashboard padr√£o j√° configurado
‚îÇ   ‚îî‚îÄ‚îÄ provisioning/
‚îÇ       ‚îú‚îÄ‚îÄ dashboards/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ dashboard.yml      # Config autom√°tica de dashboards
‚îÇ       ‚îî‚îÄ‚îÄ datasources/
‚îÇ           ‚îî‚îÄ‚îÄ datasource.yml     # Config autom√°tica do Prometheus
‚îú‚îÄ‚îÄ prometheus/
‚îÇ   ‚îú‚îÄ‚îÄ prometheus.yml             # Configura√ß√µes gerais do Prometheus
‚îÇ   ‚îî‚îÄ‚îÄ rules/                     # Regras de alerta (vazio por ora)
‚îî‚îÄ‚îÄ secrets/
    ‚îú‚îÄ‚îÄ cloudflare_token.txt       # Token do t√∫nel Cloudflare
    ‚îî‚îÄ‚îÄ grafana_password.txt       # Senha do admin no Grafana
```

## Entendendo a estrutura üóÇÔ∏è

Essa organiza√ß√£o n√£o √© √† toa. Quando os containers subirem, cada um vai buscar suas configura√ß√µes nas respectivas pastas:

- **`prometheus/`**: O Prometheus vai ler `prometheus.yml` para saber **o que** monitorar e **como**
- **`grafana/provisioning/`**: O Grafana vai auto-configurar datasources e dashboards **sem voc√™ precisar clicar em nada**
- **`grafana/dashboards/`**: Dashboards prontos que aparecem magicamente ap√≥s o primeiro login
- **`secrets/`**: Senhas isoladas com permiss√£o adequada.

√â o que chamamos de **Infrastructure as Code**: tudo definido em arquivos, version√°vel, replic√°vel. Se seu servidor explodir, voc√™ sobe tudo de novo em 5 minutos.

### ‚ö†Ô∏è IMPORTANTE: Crie o .gitignore AGORA

Antes de fazer qualquer coisa, crie o arquivo `.gitignore` na raiz do projeto. N√£o deixe para depois. S√©rio. Eu j√° vi gente commitando senha de produ√ß√£o no GitHub porque "ia fazer depois".

**homeserver-stack/.gitignore**

```bash
# Secrets (NUNCA commitar)
secrets/
*.token
*.secret
*.key

# Dados dos volumes Docker
prometheus_data/
grafana_data/

# Logs
*.log
```

### Criando as senhas

Agora vamos criar as senhas de forma segura. Use o `openssl` para gerar uma senha forte:

```bash
# Cria a pasta secrets
mkdir -p secrets

# Gera senha para o Grafana (guarde isso!)
openssl rand -base64 32 > secrets/grafana_password.txt

# O token do Cloudflare voc√™ pega no dashboard deles
# (veja meu outro post sobre Cloudflare Tunnel)
echo "SEU_TOKEN_AQUI" > secrets/cloudflare_token.txt

# Protege os arquivos
chmod 700 secrets
chmod 644 secrets/grafana_password.txt
chmod 644 secrets/cloudflare_token.txt
```

---

## O Docker Compose: Orquestrando tudo

Agora vem a parte mais importante: o arquivo que vai subir todos os containers de forma coordenada. Esse arquivo √© o c√©rebro da opera√ß√£o.

**homeserver-stack/docker-compose.yml**

```yaml
volumes:
  prometheus_data: {}
  grafana_data: {}

networks:
  monitoring:
    driver: bridge
    internal: false  # Precisa de acesso externo para Cloudflared
  metrics:
    driver: bridge
    internal: true   # Rede interna apenas para coleta de m√©tricas

secrets:
  cloudflare_token:
    file: ./secrets/cloudflare_token.txt
  grafana_admin_password:
    file: ./secrets/grafana_password.txt

services:
  # ========== NODE EXPORTER ==========
  node-exporter:
    image: prom/node-exporter:v1.8.2
    container_name: node-exporter
    restart: unless-stopped
    
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro,rslave  # rslave previne propaga√ß√£o de montagens
    
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
      - '--no-collector.ipvs'  # Desabilita coletores desnecess√°rios
    
    ports:
      - "127.0.0.1:9100:9100"  # APENAS localhost
    
    networks:
      - metrics
    
    # SEGURAN√áA
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SYS_TIME  # Necess√°rio para m√©tricas de tempo
    
    # LIMITES DE RECURSOS
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    
    # HEALTHCHECK
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9100/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ========== PROMETHEUS ==========
  prometheus:
    image: prom/prometheus:v3.6.0
    container_name: prometheus
    restart: unless-stopped
    
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'  # Reduzido para 15 dias
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
      - '--web.listen-address=:9090'
    
    ports:
      - "127.0.0.1:9090:9090"  # APENAS localhost
    
    networks:
      - monitoring
      - metrics
    
    depends_on:
      node-exporter:
        condition: service_healthy
    
    # SEGURAN√áA
    user: "65534"  # nobody
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    
    # LIMITES DE RECURSOS
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # HEALTHCHECK
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ========== GRAFANA ==========
  grafana:
    image: grafana/grafana:12.2.0
    container_name: grafana
    restart: unless-stopped
    
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/grafana_admin_password
      - GF_SERVER_ROOT_URL=https://grafana.seudominio.com
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_ALLOW_ORG_CREATE=false
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_SECURITY_DISABLE_GRAVATAR=true
      - GF_SNAPSHOTS_EXTERNAL_ENABLED=false
      - GF_LOG_MODE=console
      - GF_LOG_LEVEL=info
    
    secrets:
      - grafana_admin_password
    
    ports:
      - "127.0.0.1:3000:3000"  # APENAS localhost
    
    networks:
      - monitoring
    
    depends_on:
      prometheus:
        condition: service_healthy
    
    # SEGURAN√áA
    user: "472"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    
    # LIMITES DE RECURSOS
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # HEALTHCHECK
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ========== CLOUDFLARED ==========
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped

    environment:
      - TUNNEL_TOKEN_FILE=/run/secrets/cloudflare_token  # Usar arquivo de segredo
    
    secrets:
      - cloudflare_token
    
    command: tunnel --no-autoupdate run
    
    networks:
      - monitoring
    
    depends_on:
      prometheus:
        condition: service_healthy
      grafana:
        condition: service_healthy
    
    # SEGURAN√áA
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
      - /root/.cloudflared
    
    # LIMITES DE RECURSOS
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    
    # HEALTHCHECK
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ========== LOG ROTATION (Previne crescimento ilimitado) ==========
  logrotate:
    image: blacklabelops/logrotate:latest
    container_name: logrotate
    restart: unless-stopped
    
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log:/var/log
    
    environment:
      - LOGS_DIRECTORIES=/var/lib/docker/containers
      - LOGROTATE_INTERVAL=daily
      - LOGROTATE_COPIES=7
      - LOGROTATE_SIZE=10M
    
    # SEGURAN√áA
    security_opt:
      - no-new-privileges:true
    
    # LIMITES DE RECURSOS
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 32M
```

## Destrinchando o Docker Compose üî¨

Sei que foi muita informa√ß√£o de uma vez, ent√£o vamos entender os pontos cr√≠ticos:

### Redes isoladas üï∏Ô∏è

```yaml
networks:
  monitoring:  # Grafana, Prometheus, Cloudflare conversam aqui
    internal: false
  metrics:     # Node Exporter s√≥ fala com Prometheus (seguran√ßa!)
    internal: true
```

Por que duas redes? **Princ√≠pio do menor privil√©gio**. O Node Exporter n√£o precisa falar com o Grafana diretamente, ent√£o nem deixamos essa possibilidade existir. Se algu√©m comprometer o Grafana, n√£o consegue acessar diretamente as m√©tricas brutas.

### Portas em localhost üîí

```yaml
ports:
  - "127.0.0.1:9100:9100"  # S√ì acess√≠vel de dentro da m√°quina
```

Viu esse `127.0.0.1`? Isso significa que **apenas processos rodando no seu servidor** conseguem acessar essas portas. Nada de expor servi√ßos para a internet. S√≥ o Cloudflare Tunnel tem acesso externo, e de forma controlada.

### Health Checks ‚ù§Ô∏è‚Äçü©π

```yaml
healthcheck:
  test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9100/"]
  interval: 30s
  timeout: 10s
  retries: 3
```

O Docker vai verificar a cada 30 segundos se o servi√ßo est√° respondendo. Se falhar 3 vezes seguidas, ele reinicia o container automaticamente. √â como ter um m√©dico verificando o pulso do paciente constantemente.

### Limites de recursos üí™

```yaml
deploy:
  resources:
    limits:
      cpus: '0.5'
      memory: 128M
```

Isso evita que um container enlouque√ßa e consuma todos os recursos da m√°quina. √â tipo colocar um freio de m√£o: pode acelerar, mas n√£o passa daqui.

### Seguran√ßa hardening üõ°Ô∏è

```yaml
security_opt:
  - no-new-privileges:true
cap_drop:
  - ALL
cap_add:
  - SYS_TIME
read_only: true
```

Essas configura√ß√µes s√£o **n√≠vel paranoia**:
- `no-new-privileges`: Impede escala√ß√£o de privil√©gios
- `cap_drop: ALL`: Remove todas as capacidades do Linux
- `cap_add: SYS_TIME`: Adiciona apenas o necess√°rio
- `read_only: true`: Sistema de arquivos apenas leitura

√â como trancar todas as portas e janelas e s√≥ abrir aquela que voc√™ realmente precisa usar.

---

## Configurando o Prometheus

Agora vamos configurar o c√©rebro da coleta de m√©tricas. Crie a estrutura de pastas:

```bash
mkdir -p prometheus/rules
```

**homeserver-stack/prometheus/prometheus.yml**

```yaml
global:
  scrape_interval: 15s       # Coleta m√©tricas a cada 15 segundos
  evaluation_interval: 15s   # Avalia regras de alerta a cada 15 segundos
  
  external_labels:
    monitor: 'homeserver'
    environment: 'production'

# Configura√ß√µes de coleta
scrape_configs:
  # Monitorar o pr√≥prio Prometheus
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          instance: 'prometheus-server'
          service: 'prometheus'

  # Monitorar o host (seu PC/Servidor)
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          instance: 'homeserver-host'
          service: 'node-exporter'
          hostname: 'meu-homeserver'
```

### O que est√° acontecendo aqui?

Esse arquivo diz ao Prometheus:

1. **"V√° buscar m√©tricas a cada 15 segundos"** (`scrape_interval`)
2. **"Monitore voc√™ mesmo"** (job `prometheus`)
3. **"Monitore o Node Exporter"** (job `node-exporter`)

Os `labels` s√£o tags que voc√™ pode usar depois para filtrar e agrupar dados no Grafana. √â tipo colocar etiquetas em caixas de mudan√ßa.

---

## Configurando o Grafana

Aqui vem a m√°gica: vamos fazer o Grafana se auto-configurar. Sem precisar clicar em nada!

### Configurando o Datasource (Prometheus)

```bash
mkdir -p grafana/provisioning/datasources
```

**homeserver-stack/grafana/provisioning/datasources/datasource.yml**

```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false
    jsonData:
      timeInterval: 15s
```

Isso diz ao Grafana: **"Ei, tem um Prometheus rodando em `prometheus:9090`, conecta nele automaticamente e usa ele como fonte de dados padr√£o"**.

### Configurando Dashboards autom√°ticos

```bash
mkdir -p grafana/provisioning/dashboards
mkdir -p grafana/dashboards
```

**homeserver-stack/grafana/provisioning/dashboards/dashboard.yml**

```yaml
apiVersion: 1

providers:
  - name: 'Default'
    orgId: 1
    folder: 'Homeserver'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    allowUiUpdates: true
    options:
      path: /var/lib/grafana/dashboards
```

Isso cria automaticamente uma pasta chamada "Homeserver" no Grafana e carrega todos os dashboards que estiverem em `/var/lib/grafana/dashboards`.

### Dashboard do Node Exporter

Agora vem a parte mais legal: um dashboard completo com todas as m√©tricas do seu sistema. Mas como √© um arquivo JSON gigante (4000+ linhas), vou facilitar sua vida:

<details>
<summary><strong>üìä Clique aqui para ver como obter o dashboard completo do Node Exporter</strong></summary>

<br />

> ‚ö†Ô∏è **Aten√ß√£o:** O dashboard completo possui mais de 1.000 linhas de JSON. Copie com aten√ß√£o!

```json
{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 3,
  "links": [],
  "panels": [
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PBFA97CFB590B2093"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 6,
        "x": 0,
        "y": 0
      },
      "id": 2,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true,
        "sizing": "auto"
      },
      "pluginVersion": "12.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "editorMode": "builder",
          "expr": "100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Uso de CPU",
      "transparent": true,
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PBFA97CFB590B2093"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 6,
        "x": 6,
        "y": 0
      },
      "id": 3,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true,
        "sizing": "auto"
      },
      "pluginVersion": "12.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "100 * (1 - ((node_memory_MemAvailable_bytes) / (node_memory_MemTotal_bytes)))",
          "refId": "A"
        }
      ],
      "title": "Uso de Mem√≥ria",
      "transparent": true,
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PBFA97CFB590B2093"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 6,
        "x": 12,
        "y": 0
      },
      "id": 4,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true,
        "sizing": "auto"
      },
      "pluginVersion": "12.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "100 - ((node_filesystem_avail_bytes{mountpoint=\"/\",fstype!=\"rootfs\"} * 100) / node_filesystem_size_bytes{mountpoint=\"/\",fstype!=\"rootfs\"})",
          "refId": "A"
        }
      ],
      "title": "Uso de Disco",
      "transparent": true,
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PBFA97CFB590B2093"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dtdhms"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 6,
        "x": 18,
        "y": 0
      },
      "id": 11,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "editorMode": "builder",
          "expr": "time() - node_boot_time_seconds",
          "legendFormat": "__auto",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Uptime",
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PBFA97CFB590B2093"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "showValues": false,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 6
      },
      "id": 5,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "editorMode": "code",
          "expr": "rate(node_cpu_seconds_total{mode=\"system\"}[5m]) * 100",
          "legendFormat": "System",
          "range": true,
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "rate(node_cpu_seconds_total{mode=\"user\"}[5m]) * 100",
          "legendFormat": "User",
          "refId": "B"
        }
      ],
      "title": "CPU Usage por Modo",
      "transparent": true,
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PBFA97CFB590B2093"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "showValues": false,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "Bps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 6
      },
      "id": 7,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "rate(node_network_receive_bytes_total[5m])",
          "legendFormat": "{{device}} - Recebido",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "rate(node_network_transmit_bytes_total[5m])",
          "legendFormat": "{{device}} - Transmitido",
          "refId": "B"
        }
      ],
      "title": "Tr√°fego de Rede",
      "transparent": true,
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PBFA97CFB590B2093"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "showValues": false,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "bytes"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 7,
        "w": 24,
        "x": 0,
        "y": 14
      },
      "id": 6,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes",
          "legendFormat": "Usado",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "node_memory_MemAvailable_bytes",
          "legendFormat": "Dispon√≠vel",
          "refId": "B"
        }
      ],
      "title": "Mem√≥ria (Bytes)",
      "transparent": true,
      "type": "timeseries"
    }
  ],
  "preload": false,
  "refresh": "30s",
  "schemaVersion": 42,
  "tags": [
    "node-exporter",
    "homeserver"
  ],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "",
  "title": "Homeserver - M√©tricas do Sistema Copy",
  "uid": "ad8k974",
  "version": 21
}
```

</details>

---

## Subindo tudo! üöÄ

Agora que tudo est√° configurado, √© hora da verdade. Vamos subir a stack completa:

```bash
# Verifica se est√° tudo ok (sintaxe do YAML)
docker compose config

# Sobe todos os containers em background
docker compose up -d

# Acompanha os logs em tempo real
docker compose logs -f
```

Se tudo deu certo, voc√™ vai ver algo assim:

```
‚úî Container node-exporter  Started
‚úî Container prometheus     Started
‚úî Container grafana        Started
‚úî Container cloudflared    Started
‚úî Container logrotate      Started
```

### Verificando se est√° funcionando

```bash
# Verifica status dos containers
docker compose ps

# Testa se o Prometheus est√° respondendo
curl http://localhost:9090/-/healthy

# Testa se o Grafana est√° respondendo
curl http://localhost:3000/api/health
```

---

## Acessando o Grafana

### Localmente

Acesse `http://localhost:3000` no seu navegador.

- **Usu√°rio:** `admin`
- **Senha:** A que voc√™ gerou em `secrets/grafana_password.txt`

Para ver sua senha:

```bash
cat secrets/grafana_password.txt
```

### Remotamente (via Cloudflare Tunnel)

Se voc√™ configurou o Cloudflare Tunnel, acesse pelo dom√≠nio que voc√™ definiu:

`https://grafana.seudominio.com` ou `https://view.seudominio.com`, por exmeplo

---

## Explorando o Dashboard

Depois de fazer login:

1. Menu lateral ‚Üí **"Dashboards"**
2. Abra a pasta **"Homeserver"**
3. Clique no dashboard **"Node Exporter Full"**

Voc√™ vai ver gr√°ficos mostrando:

- **CPU**: Uso por core, modo (user, system, idle)
- **Mem√≥ria**: Usada, livre, cache, buffers
- **Disco**: Espa√ßo dispon√≠vel, I/O por segundo, lat√™ncia
- **Rede**: Taxa de transfer√™ncia, pacotes por segundo, erros
- **Sistema**: Uptime, load average, n√∫mero de processos

√â como um raio-X do seu servidor em tempo real!

---

## Comandos √∫teis

```bash
# Para tudo
docker compose down

# Para e remove volumes (CUIDADO: apaga dados hist√≥ricos)
docker compose down -v

# Reinicia um servi√ßo espec√≠fico
docker compose restart grafana

# Ver logs de um servi√ßo espec√≠fico
docker compose logs -f prometheus

# Atualizar imagens
docker compose pull
docker compose up -d

# Ver uso de recursos
docker stats
```

---

## Troubleshooting

### Grafana n√£o conecta no Prometheus

```bash
# Verifica se est√£o na mesma rede
docker network inspect homeserver-stack_monitoring

# Testa conectividade
docker exec -it grafana wget -O- http://prometheus:9090/-/healthy
```

### Node Exporter n√£o aparece no Prometheus

```bash
# Verifica targets no Prometheus
curl http://localhost:9090/api/v1/targets

# Ou acesse: http://localhost:9090/targets
```

### Container reiniciando constantemente

```bash
# Veja o que est√° acontecendo
docker compose logs nome-do-container

# Verifica health check
docker inspect nome-do-container | grep -A 10 Health
```

---

## Pr√≥ximos passos

Agora que voc√™ tem seu monitoramento funcionando:

1. **Configure alertas** no Prometheus para ser notificado quando algo der errado
2. **Adicione mais dashboards** do Grafana Labs
3. **Monitore outros servi√ßos** (Docker, Nginx, PostgreSQL, etc.)
4. **Configure backups** dos dados do Grafana e Prometheus
5. **Explore o PromQL** para criar suas pr√≥prias queries

---

## Conclus√£o

Parab√©ns! Voc√™ acabou de montar um sistema de monitoramento profissional no seu homeserver. O mesmo tipo de stack que empresas como Uber, SoundCloud e DigitalOcean usam em produ√ß√£o.

Agora voc√™ tem:
- ‚úÖ Visibilidade completa do seu servidor
- ‚úÖ Dashboards bonitos e informativos
- ‚úÖ Acesso seguro de qualquer lugar
- ‚úÖ Uma base s√≥lida para expandir

E o melhor: **tudo open-source e de gra√ßa**.

Curtiu? Compartilha a√≠ e me marca! Tem d√∫vidas? Comenta que eu respondo.

At√© a pr√≥xima!

---

**Links √∫teis:**
- [Documenta√ß√£o do Prometheus](https://prometheus.io/docs/)
- [Documenta√ß√£o do Grafana](https://grafana.com/docs/)
- [Dashboards da comunidade](https://grafana.com/grafana/dashboards/)
- [Meu post sobre Cloudflare Tunnel](/blog/cloudflared-tunnel-tutorail)